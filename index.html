<!DOCTYPE html>
<html>
    <head>
      <title>Example</title>

      <script src="vendor.bundle.js" type="text/javascript" charset="utf-8" defer></script>
      <script src="bundle.js" type="text/javascript" charset="utf-8" defer></script>
      <!-- <script src="https://apis.google.com/js/api.js"></script> -->
    </head>
    <body class="container-fluid">

      <p>Say hello using the People API.</p>

          <!--Add buttons to initiate auth sequence and sign out-->
          <button id="authorize-button" style="display: none;">Authorize</button>
          <button id="signout-button" style="display: none;">Sign Out</button>

          <ul class = 'list'>

          </ul>

          <div id="content"></div>
<!-- https://developers.google.com/api-client-library/javascript/start/start-js -->
          <script type="text/javascript">
            // Enter an API key from the Google API Console:
            //   https://console.developers.google.com/apis/credentials?project=_
            let apiKey = 'YOUR_API_KEY';
            // Enter a client ID for a web application from the Google API Console:
            //   https://console.developers.google.com/apis/credentials?project=_
            // In your API Console project, add a JavaScript origin that corresponds
            //   to the domain where you will be running the script.
            let clientId = 'YOUR_WEB_CLIENT_ID.apps.googleusercontent.com';
            // Enter one or more authorization scopes. Refer to the documentation for
            // the API or https://developers.google.com/identity/protocols/googlescopes
            // for details.
            let scopes = 'profile';


            let auth2; // The Sign-In object.
            let authorizeButton = document.getElementById('authorize-button');
            let signoutButton = document.getElementById('signout-button');
            function handleClientLoad() {
              // Load the API client and auth library
              gapi.load('client:auth2', initAuth);
            }
            function initAuth() {
              gapi.client.setApiKey(apiKey);
              gapi.auth2.init({
                  client_id: clientId,
                  scope: scopes
              }).then(function () {
                auth2 = gapi.auth2.getAuthInstance();
                // Listen for sign-in state changes.
                auth2.isSignedIn.listen(updateSigninStatus);
                // Handle the initial sign-in state.
                updateSigninStatus(auth2.isSignedIn.get());
                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
              });
            }
            function updateSigninStatus(isSignedIn) {
              if (isSignedIn) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
                makeApiCall();
              } else {
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';
              }
            }
            function handleAuthClick(event) {
              auth2.signIn();
            }
            function handleSignoutClick(event) {
              auth2.signOut();
            }
  // Load the API and make an API call.  Display the results on the screen.
            function makeApiCall() {
            gapi.client.load('people', 'v1').then(function() {
                let request = gapi.client.people.people.connections.list({
                    resourceName: 'people/me',
                    pageSize: 200,
                    fields: 'connections(resourceName)'
                });

                request.execute(function(resp) {
                    if (resp.connections){
                      let batch = gapi.client.newBatch();
                      let emails = [];
                      for(let i = 0; i < resp.connections.length; i++){
                        let req = gapi.client.people.people.get({
                          resourceName: resp.connections[i].resourceName,
                          fields: "emailAddresses(value)"
                          });
                          batch.add(req);
                          req.then(function (email){
                            let idx = email.body.indexOf("{");
                            let jsonString = email.body.substring(idx > 0 ? idx : 0);
                            let obj;
                            try {
                            obj = JSON.parse(jsonString);
                            if (obj.emailAddresses){
                                for (j = 0; j < obj.emailAddresses.length; j++){
                                    emails.push(obj.emailAddresses[j].value);
                                }
                              }
                            }
                            catch (err) {
                            console.error(email);
                            }
                        })
                      }
                        batch.then(function (){
                          console.log(emails);
                          let fullList = '';
                          for (let i = 0; i < emails.length; i++){
                            fullList += '<li>' + emails[i] + '</li>';
                          }
                            $('.list').append(fullList);

                        }, function (err){
                          console.error(err);
                        });
                    } else {
                      console.error("Error", resp);
                    }
                });
            }, function (err){
                console.error(err);
            });

        }
          </script>
          <script src="https://apis.google.com/js/api.js?onload=handleClientLoad"></script>

    </body>
</html>
